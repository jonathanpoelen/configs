#!/bin/sh

FIFO=${TMPDIR-/tmp/}/icling.$$.zsh
FILE=${TMPDIR-/tmp/}/icling.$$.cpp
mkfifo $FIFO

echo '#!/bin/zsh
sh() { vt-kate-syntax-highlighter -t"Breeze Dark" -uscpp }
tail -f '$FIFO' 2>/dev/null >>(stdbuf -o0 cling | sh) >>(sh)
' > $FIFO.sh
chmod u+x $FIFO.sh

nvim -n \
 --cmd 'inoremap <CR> <ESC>:exe "!echo " . shellescape(getline(getpos(".")[1])) . "> '$FIFO'"<CR>$a<CR>' \
 --cmd 'inoremap <C-q> <ESC>:qall!<CR>' \
 --cmd 'set termguicolors' \
 --cmd 'set mouse=a' \
 --cmd startinsert \
 -O $FILE -O 'term://'$FIFO.sh

rm -f -- $FIFO.sh $FIFO $FILE
killall $FIFO.sh 2>/dev/null
exit 0
