#!/bin/sh
echo '<html>
<head>
	<title>Viewer '"$(dirname "$0")/$1"'</title>
	<meta http-equiv="Content-Type" content="application/xhtml+xml;charset=UTF-8" />
	<style>
	body{margin:0;padding:0;background:#000}
	img{display:block;margin:auto;max-width:100%}
	</style>
</head>
<body>
<img src="" />
<script type="text/javascript">
var names = ['

while [ $# != 0 ] ; do
	find "$1" -type f | grep -vE '/Thumbs.db$|\.directory$' | sort | sed -E s'/(.*)/"\1",/'
	shift 1
done

echo '];

var n = +window.location.search.split("=")[1] || 0;
var img = document.getElementsByTagName("img")[0];
var body = document.body;
var len = names.length;
img.src = names[n];
var iswebkit = (/(webkit)[ \/]([\w.]+)/).exec(navigator.userAgent.toLowerCase())

var dp = false;

var key_actions = {
	"69": function(){ n = Math.min(n+12, len-1); },
	"65": function(){ n = Math.max(n-12, 0); },
	"37": function(){ n && --n; },
	"39": function(){ n !== len && ++n; }
};
key_actions["8"] = key_actions["37"];

window.addEventListener(iswebkit ? "keydown" : "keypress", function(e){
	var a;
	if ((a = key_actions[e.keyCode]))
	{
		a();
		img.src = names[n];
		body.scrollTop = 0;
		return false;
	} else if ((e.keyCode === 0 || e.keyCode === 32) && body.clientHeight + (iswebkit ? body.scrollTop : e.pageY) >= body.scrollHeight - 20 && n !== len){
		e.preventDefault();
		if (dp) {
      img.src = names[++n];
    }
    dp = !dp;
		body.scrollTop = 0;
		//window.location.search = "?n="+n;
		return false;
	}
	return true;
}, false);
</script>
</body>
</html>'
